# üöÄ Sistema de Despliegue Blue-Green para MundoGrafic

Este documento explica c√≥mo implementar y usar un sistema de despliegue Blue-Green en tu servidor Debian para tu aplicaci√≥n MundoGrafic.

## üéØ ¬øQu√© es Blue-Green Deployment?

El despliegue Blue-Green es una estrategia que mantiene dos entornos id√©nticos:
- **üü¶ Blue**: Entorno de producci√≥n actual
- **üü© Green**: Entorno de pruebas/desarrollo

**Ventajas:**
- ‚úÖ Cero tiempo de inactividad durante despliegues
- ‚úÖ Rollback instant√°neo en caso de problemas
- ‚úÖ Pruebas seguras en entorno de producci√≥n
- ‚úÖ Facilita testing A/B

## üìã Prerrequisitos

- Servidor Debian 11/12 con acceso root
- Git instalado en el servidor
- Acceso SSH al servidor
- Tu c√≥digo fuente en un repositorio Git

## üîß Configuraci√≥n Inicial del Servidor

### Paso 1: Copiar scripts al servidor

```bash
# Desde tu m√°quina local, copia los scripts al servidor
scp setup-blue-green-server.sh usuario@tu-servidor:/tmp/
scp blue-green-deploy.sh usuario@tu-servidor:/tmp/
```

### Paso 2: Ejecutar configuraci√≥n inicial

```bash
# Conectarse al servidor
ssh usuario@tu-servidor

# Ejecutar como root
sudo bash /tmp/setup-blue-green-server.sh
```

Este script:
- ‚úÖ Actualiza el sistema
- ‚úÖ Instala Node.js, Nginx, PM2
- ‚úÖ Crea usuario `app` para la aplicaci√≥n
- ‚úÖ Configura directorios Blue-Green
- ‚úÖ Configura Nginx autom√°ticamente
- ‚úÖ Configura firewall b√°sico
- ‚úÖ Crea scripts de gesti√≥n

### Paso 3: Copiar tu c√≥digo al servidor

```bash
# En el servidor, copia tu c√≥digo
sudo cp -r /ruta/a/tu/proyecto/* /opt/mundografic/frontend/
sudo cp -r /ruta/a/tu/backend/* /opt/mundografic/backend/

# Establecer permisos
sudo chown -R app:app /opt/mundografic
```

## üöÄ Primer Despliegue

### Desplegar en entorno Blue (producci√≥n)

```bash
# Copiar el script de despliegue
sudo cp /tmp/blue-green-deploy.sh /opt/mundografic/
sudo chmod +x /opt/mundografic/blue-green-deploy.sh

# Navegar al directorio del frontend
cd /opt/mundografic/frontend

# Desplegar en Blue
sudo bash /opt/mundografic/blue-green-deploy.sh blue
```

### Verificar el despliegue

```bash
# Ver estado del sistema
sudo bash /opt/mundografic/blue-green-deploy.sh status

# Ver logs de Nginx
sudo tail -f /var/log/nginx/mundografic_error.log
```

## üîÑ Flujo de Trabajo Blue-Green

### 1. Desarrollo y Pruebas

```bash
# Desplegar nueva versi√≥n en Green (entorno de pruebas)
cd /opt/mundografic/frontend
sudo bash /opt/mundografic/blue-green-deploy.sh green
```

### 2. Probar en Green

- üåê Accede a tu aplicaci√≥n
- üß™ Prueba todas las funcionalidades
- ‚úÖ Verifica que todo funcione correctamente

### 3. Cambiar a Producci√≥n

```bash
# Cambiar de Blue a Green (nueva versi√≥n)
sudo bash /opt/mundografic/blue-green-deploy.sh switch
```

### 4. Verificar Producci√≥n

```bash
# Ver estado
sudo bash /opt/mundografic/blue-green-deploy.sh status

# Monitorear logs
sudo tail -f /var/log/nginx/mundografic_access.log
```

## üõ†Ô∏è Comandos Principales

### Despliegue

```bash
# Desplegar en Blue
sudo bash /opt/mundografic/blue-green-deploy.sh blue

# Desplegar en Green
sudo bash /opt/mundografic/blue-green-deploy.sh green

# Cambiar entre entornos
sudo bash /opt/mundografic/blue-green-deploy.sh switch
```

### Monitoreo

```bash
# Ver estado completo
sudo bash /opt/mundografic/blue-green-deploy.sh status

# Monitoreo b√°sico
sudo bash /opt/mundografic/monitor.sh

# Logs de Nginx
sudo tail -f /var/log/nginx/mundografic_error.log
sudo tail -f /var/log/nginx/mundografic_access.log
```

### Gesti√≥n

```bash
# Hacer rollback
sudo bash /opt/mundografic/blue-green-deploy.sh rollback

# Ver backups disponibles
ls -la /var/backups/mundografic/

# Reiniciar Nginx
sudo systemctl restart nginx
```

## üîÑ Flujo de Desarrollo T√≠pico

### Escenario 1: Nueva Funcionalidad

```bash
# 1. Desarrollar en tu m√°quina local
git add .
git commit -m "Nueva funcionalidad"
git push origin main

# 2. En el servidor, desplegar en Green
cd /opt/mundografic/frontend
sudo bash /opt/mundografic/blue-green-deploy.sh green

# 3. Probar en Green
# Acceder a la aplicaci√≥n y verificar

# 4. Si todo est√° bien, cambiar a producci√≥n
sudo bash /opt/mundografic/blue-green-deploy.sh switch

# 5. Verificar que Blue (producci√≥n) funcione
sudo bash /opt/mundografic/blue-green-deploy.sh status
```

### Escenario 2: Rollback por Problemas

```bash
# 1. Detectar problema en producci√≥n
# 2. Hacer rollback inmediato
sudo bash /opt/mundografic/blue-green-deploy.sh rollback

# 3. Verificar que el rollback funcion√≥
sudo bash /opt/mundografic/blue-green-deploy.sh status

# 4. Investigar y corregir el problema
# 5. Desplegar versi√≥n corregida en Green
sudo bash /opt/mundografic/blue-green-deploy.sh green
```

## üìÅ Estructura de Directorios

```
/opt/mundografic/
‚îú‚îÄ‚îÄ frontend/                    # C√≥digo fuente del frontend
‚îú‚îÄ‚îÄ backend/                     # C√≥digo fuente del backend
‚îú‚îÄ‚îÄ blue-green-deploy.sh        # Script principal de despliegue
‚îú‚îÄ‚îÄ monitor.sh                   # Script de monitoreo
‚îú‚îÄ‚îÄ auto-backup.sh              # Script de backup autom√°tico
‚îî‚îÄ‚îÄ ecosystem.config.js         # Configuraci√≥n de PM2

/var/www/
‚îú‚îÄ‚îÄ mundografic-blue/           # Entorno Blue (producci√≥n)
‚îú‚îÄ‚îÄ mundografic-green/          # Entorno Green (pruebas)
‚îî‚îÄ‚îÄ mundografic -> mundografic-blue  # Enlace simb√≥lico

/var/backups/mundografic/       # Backups autom√°ticos
/var/log/mundografic/           # Logs de la aplicaci√≥n
```

## üîí Seguridad y Permisos

### Usuarios y Permisos

- **Usuario `app`**: Propietario del c√≥digo fuente
- **Usuario `www-data`**: Propietario de archivos web
- **Usuario `root`**: Solo para operaciones de despliegue

### Firewall

- ‚úÖ Puerto 22 (SSH) abierto
- ‚úÖ Puerto 80 (HTTP) abierto
- ‚úÖ Puerto 443 (HTTPS) abierto
- ‚ùå Todos los dem√°s puertos cerrados

## üìä Monitoreo y Logs

### Logs de Nginx

```bash
# Logs de acceso
sudo tail -f /var/log/nginx/mundografic_access.log

# Logs de error
sudo tail -f /var/log/nginx/mundografic_error.log

# Logs generales
sudo tail -f /var/log/nginx/error.log
```

### Logs de la Aplicaci√≥n

```bash
# Logs de PM2 (backend)
sudo -u app pm2 logs

# Logs personalizados
sudo tail -f /var/log/mundografic/combined.log
```

### Monitoreo del Sistema

```bash
# Estado de servicios
sudo systemctl status nginx
sudo -u app pm2 status

# Uso de recursos
htop
df -h
free -h
```

## üö® Soluci√≥n de Problemas

### Problema 1: Nginx no inicia

```bash
# Verificar configuraci√≥n
sudo nginx -t

# Ver logs de error
sudo journalctl -u nginx -f

# Verificar permisos
ls -la /var/www/mundografic/
```

### Problema 2: Frontend no carga

```bash
# Verificar enlace simb√≥lico
ls -la /var/www/mundografic

# Verificar archivos
ls -la /var/www/mundografic-blue/
ls -la /var/www/mundografic-green/

# Verificar permisos
sudo chown -R www-data:www-data /var/www/mundografic-*
```

### Problema 3: API no responde

```bash
# Verificar estado del backend
sudo -u app pm2 status

# Verificar puerto
sudo netstat -tlnp | grep :3000

# Ver logs del backend
sudo -u app pm2 logs
```

### Problema 4: Error en despliegue

```bash
# Ver estado del sistema
sudo bash /opt/mundografic/blue-green-deploy.sh status

# Ver logs de Nginx
sudo tail -f /var/log/nginx/mundografic_error.log

# Verificar directorios
sudo ls -la /var/www/
```

## üîÑ Actualizaciones y Mantenimiento

### Actualizar Dependencias

```bash
# En tu m√°quina local
npm update
git add package*.json
git commit -m "Actualizar dependencias"
git push origin main

# En el servidor
cd /opt/mundografic/frontend
sudo bash /opt/mundografic/blue-green-deploy.sh green
```

### Limpiar Backups Antiguos

```bash
# Ver backups
ls -la /var/backups/mundografic/

# Eliminar backups antiguos (m√°s de 30 d√≠as)
sudo find /var/backups/mundografic/ -name "backup_*" -mtime +30 -delete
```

### Actualizar Scripts

```bash
# Copiar nuevos scripts
scp blue-green-deploy.sh usuario@servidor:/tmp/
sudo cp /tmp/blue-green-deploy.sh /opt/mundografic/
sudo chmod +x /opt/mundografic/blue-green-deploy.sh
```

## üìà Mejores Pr√°cticas

### 1. Siempre Prueba en Green

- ‚úÖ Nunca despliegues directamente en Blue
- ‚úÖ Siempre usa Green para pruebas
- ‚úÖ Solo cambia a Blue cuando est√©s seguro

### 2. Backups Regulares

- ‚úÖ Los backups se crean autom√°ticamente
- ‚úÖ Mant√©n al menos 7 d√≠as de backups
- ‚úÖ Verifica que los backups funcionen

### 3. Monitoreo Continuo

- ‚úÖ Revisa logs regularmente
- ‚úÖ Monitorea el estado del sistema
- ‚úÖ Configura alertas si es posible

### 4. Rollback R√°pido

- ‚úÖ Ten un plan de rollback
- ‚úÖ Practica el rollback regularmente
- ‚úÖ Documenta problemas y soluciones

## üéØ Casos de Uso Comunes

### Desarrollo Diario

```bash
# 1. Desplegar cambios en Green
sudo bash /opt/mundografic/blue-green-deploy.sh green

# 2. Probar cambios
# 3. Si hay problemas, corregir y repetir
# 4. Si todo est√° bien, cambiar a producci√≥n
sudo bash /opt/mundografic/blue-green-deploy.sh switch
```

### Lanzamiento de Versi√≥n

```bash
# 1. Crear tag de versi√≥n
git tag v1.2.0
git push origin v1.2.0

# 2. Desplegar en Green
sudo bash /opt/mundografic/blue-green-deploy.sh green

# 3. Pruebas exhaustivas
# 4. Cambiar a producci√≥n
sudo bash /opt/mundografic/blue-green-deploy.sh switch

# 5. Monitorear producci√≥n
sudo bash /opt/mundografic/monitor.sh
```

### Mantenimiento de Emergencia

```bash
# 1. Detectar problema cr√≠tico
# 2. Rollback inmediato
sudo bash /opt/mundografic/blue-green-deploy.sh rollback

# 3. Investigar problema
# 4. Corregir y probar en Green
# 5. Desplegar correcci√≥n cuando est√© lista
```

## üìû Soporte y Ayuda

### Comandos de Diagn√≥stico

```bash
# Estado completo del sistema
sudo bash /opt/mundografic/blue-green-deploy.sh status

# Monitoreo en tiempo real
sudo bash /opt/mundografic/monitor.sh

# Ver logs en tiempo real
sudo tail -f /var/log/nginx/mundografic_error.log
```

### Informaci√≥n del Sistema

```bash
# Versiones instaladas
node --version
npm --version
nginx -v
pm2 --version

# Estado de servicios
sudo systemctl status nginx
sudo -u app pm2 status

# Uso de recursos
df -h
free -h
```

---

## üéâ ¬°Tu Sistema Blue-Green est√° Listo!

Con este sistema tienes:
- ‚úÖ Despliegues sin tiempo de inactividad
- ‚úÖ Rollback instant√°neo
- ‚úÖ Entorno de pruebas seguro
- ‚úÖ Monitoreo completo
- ‚úÖ Backups autom√°ticos

**¬°Disfruta de despliegues seguros y profesionales! üöÄ**
